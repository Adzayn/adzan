<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, viewport-fit=cover">
  <title>Jadwal Sholat TV Masjid</title>
  <link rel="stylesheet" href="style.css">
  <style>@view-transition { navigation: auto; }</style>
  
 </head>
 <body class="h-full w-full">
  <div id="app" class="h-full w-full"></div>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <script>
    // ============================================
    // KONFIGURASI DEFAULT
    // ============================================
    
    const DEFAULT_CONFIG = {
      // Informasi Masjid
      nama_masjid: "MASJID MISBAHUL KHOIR",
      alamat_masjid: "RT 10 RW 05 KUREN DADI PLAOSAN MAGETAN",
      logo: null, // Custom logo URL/Base64
      hijri_adjustment: 0, // Koreksi hari Hijriyah (+/- hari)
      gregorian_adjustment: 0, // Koreksi hari Masehi (+/- hari)
      
      // Waktu Sholat (format 24 jam: HH:MM)
      waktu_sholat: {
        imsak: "04:18",
        subuh: "04:28",
        dhuha: "06:15",
        dhuhur: "11:52",
        ashar: "15:12",
        maghrib: "17:58",
        isya: "19:10"
      },
      
      // Opsi Tampilan Waktu Sholat
      tampilkan_imsak: true,
      tampilkan_dhuha: true,

      // Keuangan Masjid
      periode_keuangan: "Januari 2025",
      pemasukan: 25000000,
      pengeluaran: 18500000,
      donatur: [
        { nama: "Hamba Allah", jumlah: 500000 },
        { nama: "Bpk. Ahmad", jumlah: 1000000 },
        { nama: "Ibu Siti", jumlah: 250000 }
      ],
      
      // Petugas Sholat
      petugas_jumat: [
        { hari: "JUMAT PON", imam: "Bp Muh Ichsan", khotib: "Bp Muh Ichsan", muadzin: "Bp Sukadi" },
        { hari: "JUMAT WAGE", imam: "Bp Agus Susilo", khotib: "Bp Agus Susilo", muadzin: "Bp Suwarno" },
        { hari: "JUMAT KLIWON", imam: "Bp H Yusup", khotib: "Bp H Yusup", muadzin: "Bp Paimin" },
        { hari: "JUMAT LEGI", imam: "Ustadz Joko", khotib: "Ustadz Karim", muadzin: "Ustadz Lukman" },
        { hari: "JUMAT PAHING", imam: "Ustadz Mamat", khotib: "Ustadz Nana", muadzin: "Ustadz Oka" },
        { hari: "CADANGAN 1", imam: "Ustadz Cadangan 1", khotib: "Ustadz Cadangan 1", muadzin: "Ustadz Cadangan 1" },
        { hari: "CADANGAN 2", imam: "Ustadz Cadangan 2", khotib: "Ustadz Cadangan 2", muadzin: "Ustadz Cadangan 2" }
      ],
      petugas_harian: [
        { hari: "SENIN" , tanggal: "", imam: "Bp Muh Ichsan", muadzin: "Bp Muh Ichsan" },
        { hari: "SELASA", tanggal: "", imam: "Bp Sukadi", muadzin: "Bp Agus Susilo" },
        { hari: "RABU"  , tanggal: "", imam: "Bp Agus Susilo", muadzin: "Bp Suwarno" },
        { hari: "KAMIS" , tanggal: "", imam: "Bp H Yusup", muadzin: "Bp H Yusup" },
        { hari: "JUMAT" , tanggal: "", imam: "Bp Paimin", muadzin: "Ustadz Joko" },
        { hari: "SABTU" , tanggal: "", imam: "Ustadz Karim", muadzin: "Ustadz Lukman" },
        { hari: "AHAD"  , tanggal: "", imam: "Ustadz Mamat", muadzin: "Ustadz Nana" }
      ],
      
      // Running Text (pisahkan dengan tanda ‚Ä¢)
      running_text: "Selamat datang di MASJID MISBAHUL KHOIR üïå Kajian Rutin Setiap Jum'at Ba'da Maghrib ‚Ä¢ Mari tertib dalam beribadah ‚Ä¢ Jaga kebersihan masjid",
      
      // Pengaturan Tampilan
      show_finance: true, // Tampilkan keuangan masjid dan donatur
      show_slider: true, // Tampilkan slider gambar
      
      // Informasi (kosongkan jika tidak ingin ditampilkan)
      info_1: "Mari jaga kebersihan masjid. Buang sampah pada tempatnya dan rapikan sandal setelah digunakan.",
      info_2: "Matikan HP saat sholat dan jaga kekhusyukan ibadah. Hindari berbicara di dalam masjid.",
      info_3: "Luruskan dan rapatkan shaf. Sholat berjamaah lebih utama daripada sholat sendirian.",
      
      // Slide (Gambar & Teks)
      slides: [
        {
          type: 'image',
          url: 'slide/slide1.jpg',
          text: 'Wahai orang-orang yang beriman, diwajibkan atas kamu berpuasa sebagaimana diwajibkan atas orang-orang sebelum kamu agar kamu bertakwa. (QS Al-Baqarah: 183)'
        },
        {
          type: 'image',
          url: 'slide/slide2.jpg',
          text: '(yaitu) dalam beberapa hari yang tertentu. Maka barangsiapa diantara kamu ada yang sakit atau dalam perjalanan (lalu ia berbuka), maka (wajiblah baginya berpuasa) sebanyak hari yang ditinggalkan itu pada hari-hari yang lain. (QS Al-Baqarah:184)'
        },
        {
          type: 'image',
          url: 'slide/slide3.jpg',
          text: '(Beberapa hari yang ditentukan itu ialah) bulan Ramadhan, bulan yang di dalamnya diturunkan (permulaan) Al Quran sebagai petunjuk bagi manusia dan penjelasan-penjelasan mengenai petunjuk itu dan pembeda (antara yang hak dan yang bathil). (QS Al-Baqarah :185)'
        },
        {
          type: 'image',
          url: 'slide/slide4.jpg',
          text: 'Barangsiapa yang mengerjakan kebaikan seberat dzarrahpun, niscaya dia akan melihat (balasan)nya. Dan barangsiapa yang mengerjakan kejahatan sebesar dzarrahpun, niscaya dia akan melihat (balasan)nya pula.‚Äù (Q.S. Az-Zalzalah: 7-8)'
        },
        {
          type: 'image',
          url: 'slide/slide5.jpg',
          text: 'Dan kelak Tuhanmu pasti memberikan karunia-Nya kepadamu, lalu (hati) kamu menjadi puas. (Q.S. Ad-Duha: 5)'
        }
      ],
      
      // Warna Tema (format: #RRGGBB)
      colors: {
        background: "#0F1B07",
        header: "#5C821A",
        accent: "#C6D166",
        text: "#FFFFFF",
        secondary_text: "#C6D166"
      },
      
      // Font dan Ukuran
      font_family: "system-ui",
      font_size: 18,
      resolusi: "fhd", // hd, fhd, 4k
      aspect_ratio: null, // 16:9, 18:9, 19:9, 20:9, 21:9

      // Audio Files (DataURL)
      audio: {
        adzan: 'audio/adzan.mp3',
        iqomah: 'audio/beep.mp3'
      }
    };
    
    // ============================================
    // THEMES CONFIGURATION
    // ============================================
    const THEMES = [
      {
        id: 'default',
        name: 'Hijau Alam',
        colors: {
          background: "#0F1B07",
          header: "#5C821A",
          accent: "#C6D166",
          text: "#FFFFFF",
          secondary_text: "#C6D166"
        }
      },
      {
        id: 'midnight',
        name: 'Biru Malam',
        colors: {
          background: "#0a1929",
          header: "#1a237e",
          accent: "#4fc3f7",
          text: "#FFFFFF",
          secondary_text: "#4fc3f7"
        }
      },
      {
        id: 'royal',
        name: 'Emas Mewah',
        colors: {
          background: "#1a1a1a",
          header: "#3e2723",
          accent: "#ffc107",
          text: "#FFFFFF",
          secondary_text: "#ffc107"
        }
      },
      {
        id: 'amethyst',
        name: 'Ungu Spiritual',
        colors: {
          background: "#42002E",
          header: "#4a148c",
          accent: "#ea80fc",
          text: "#FFFFFF",
          secondary_text: "#ea80fc"
        }
      },
      {
        id: 'sunset',
        name: 'Senja',
        colors: {
          background: "#2d1b0e",
          header: "#bf360c",
          accent: "#ffab91",
          text: "#FFFFFF",
          secondary_text: "#ffab91"
        }
      }
    ];

    // Load Config from LocalStorage or use Default
    let CONFIG = JSON.parse(localStorage.getItem('mosqueConfig')) || DEFAULT_CONFIG;

    // Ensure backward compatibility if new fields are added
    CONFIG = { ...DEFAULT_CONFIG, ...CONFIG };
    if (!CONFIG.slides) CONFIG.slides = DEFAULT_CONFIG.slides;
    if (!CONFIG.audio) CONFIG.audio = DEFAULT_CONFIG.audio;
    if (!CONFIG.donatur) CONFIG.donatur = DEFAULT_CONFIG.donatur;
    if (!CONFIG.petugas_jumat) CONFIG.petugas_jumat = DEFAULT_CONFIG.petugas_jumat;
    if (!CONFIG.petugas_harian) CONFIG.petugas_harian = DEFAULT_CONFIG.petugas_harian;
    if (CONFIG.show_finance === undefined) CONFIG.show_finance = DEFAULT_CONFIG.show_finance;
    if (CONFIG.show_slider === undefined) CONFIG.show_slider = DEFAULT_CONFIG.show_slider;
    if (CONFIG.tampilkan_imsak === undefined) CONFIG.tampilkan_imsak = DEFAULT_CONFIG.tampilkan_imsak;
    if (CONFIG.tampilkan_dhuha === undefined) CONFIG.tampilkan_dhuha = DEFAULT_CONFIG.tampilkan_dhuha;
    if (!CONFIG.resolusi) CONFIG.resolusi = "fhd";
    if (!CONFIG.aspect_ratio) CONFIG.aspect_ratio = "16:9";
    
    // Migration: Downscale font sizes for better proportionality
    if (CONFIG.font_size === 24) {
      CONFIG.font_size = 18; // FHD: 24 -> 18
      localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
    }
    if (CONFIG.font_size === 48) {
      CONFIG.font_size = 36; // 4K: 48 -> 36
      localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
    }
    if (CONFIG.font_size === 18 && CONFIG.resolusi === 'hd') {
      CONFIG.font_size = 14; // HD: 18 -> 14 (only if explicitly set to HD, to avoid conflict with new FHD default)
      localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
    }

    // Migration: jumat -> dhuhur
    if (CONFIG.waktu_sholat.jumat && !CONFIG.waktu_sholat.dhuhur) {
      CONFIG.waktu_sholat.dhuhur = CONFIG.waktu_sholat.jumat;
      delete CONFIG.waktu_sholat.jumat;
      // Save migration
      localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
    }

    
    // ============================================
    // JANGAN EDIT DI BAWAH INI KECUALI ANDA PAHAM KODE
    // ============================================
    
    function getResponsiveFontSize() {
      const base = CONFIG.font_size || 18;
      const width = window.innerWidth || document.documentElement.clientWidth || (document.body && document.body.clientWidth) || 0;
      if (!width) return base;
      if (width <= 480) return Math.round(base * 0.6);
      if (width <= 768) return Math.round(base * 0.8);
      return base;
    }
    
    function getEffectiveDate() {
      const now = new Date();
      if (CONFIG.gregorian_adjustment) {
        now.setDate(now.getDate() + parseInt(CONFIG.gregorian_adjustment));
      }
      return now;
    }

    function getPrayerTimes() {
      const now = getEffectiveDate();
      const isFriday = now.getDay() === 5; // 0 = Sunday, 5 = Friday
      
      const times = [
        { name: 'Imsak', time: CONFIG.waktu_sholat.imsak, icon: 'üåå', show: CONFIG.tampilkan_imsak },
        { name: 'Subuh', time: CONFIG.waktu_sholat.subuh, icon: 'üåÖ', show: true },
        { name: 'Dhuha', time: CONFIG.waktu_sholat.dhuha, icon: '‚òÄÔ∏è', show: CONFIG.tampilkan_dhuha },
        { 
          name: isFriday ? "Jum'at" : 'Dhuhur', 
          time: CONFIG.waktu_sholat.dhuhur, 
          icon: isFriday ? 'üïå' : 'üïõ',
          show: true
        },
        { name: 'Ashar', time: CONFIG.waktu_sholat.ashar, icon: 'üå§Ô∏è', show: true },
        { name: 'Maghrib', time: CONFIG.waktu_sholat.maghrib, icon: 'üåÜ', show: true },
        { name: 'Isya', time: CONFIG.waktu_sholat.isya, icon: 'üåô', show: true }
      ];

      return times.filter(t => t.show !== false);
    }

    function getCurrentTime() {
      const now = new Date();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      return `${hours}:${minutes}:${seconds}`;
    }

    // Function to get Gregorian date for a specific day of week
    function getGregorianDateForDay(targetDay) {
      const daysMap = {
        'AHAD': 0, 'MINGGU': 0,
        'SENIN': 1,
        'SELASA': 2,
        'RABU': 3,
        'KAMIS': 4,
        'JUMAT': 5,
        'SABTU': 6
      };
      
      const now = getEffectiveDate();
      const currentDay = now.getDay();
      const targetDayIndex = daysMap[targetDay.toUpperCase()] || 0;
      
      // Calculate days difference
      let daysDiff = targetDayIndex - currentDay;
      if (daysDiff < 0) daysDiff += 7;
      
      const targetDate = new Date(now);
      targetDate.setDate(now.getDate() + daysDiff);
      
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
      return `${targetDate.getDate()} ${months[targetDate.getMonth()]} ${targetDate.getFullYear()}`;
    }
    
    // Function to get Hijri date for a specific day of week
    function getHijriDateForDay(targetDay) {
      const daysMap = {
        'AHAD': 0, 'MINGGU': 0,
        'SENIN': 1,
        'SELASA': 2,
        'RABU': 3,
        'KAMIS': 4,
        'JUMAT': 5,
        'SABTU': 6
      };
      
      const now = getEffectiveDate();
      const currentDay = now.getDay();
      const targetDayIndex = daysMap[targetDay.toUpperCase()] || 0;
      
      // Calculate days difference
      let daysDiff = targetDayIndex - currentDay;
      if (daysDiff < 0) daysDiff += 7;
      
      const targetDate = new Date(now);
      targetDate.setDate(now.getDate() + daysDiff);
      
      // Apply hijri adjustment
      targetDate.setDate(targetDate.getDate() + (parseInt(CONFIG.hijri_adjustment) || 0));
      
      try {
        const hijriMonths = ['Muharram', 'Safar', 'Rabiul Awal', 'Rabiul Akhir', 'Jumadil Awal', 'Jumadil Akhir', 'Rajab', 'Sya\'ban', 'Ramadhan', 'Syawal', 'Dzulqa\'dah', 'Dzulhijjah'];
        
        const hijriFormatter = new Intl.DateTimeFormat('en-u-ca-islamic-umalqura-nu-latn', {
            day: 'numeric',
            month: 'numeric',
            year: 'numeric'
        });
        const parts = hijriFormatter.formatToParts(targetDate);
        const hDay = parts.find(p => p.type === 'day').value;
        const hMonthIndex = parseInt(parts.find(p => p.type === 'month').value) - 1;
        const hYear = parts.find(p => p.type === 'year').value;
        
        const hMonthName = hijriMonths[hMonthIndex] || '';
        return `${String(hDay).padStart(2, '0')} ${hMonthName} ${hYear}`;
      } catch (e) {
        console.error("Hijri date error", e);
        return "";
      }
    }

    function getHijriDate(date) {
      const options = { year: 'numeric', month: '2-digit', day: '2-digit', calendar: 'islamic-umalqura' };
      const hijriDate = new Intl.DateTimeFormat('id-ID-u-ca-islamic-umalqura', options).format(date);
      // Format is usually dd/mm/yyyy. We need to ensure it's formatted correctly as per request.
      // Intl might return like "26/06/1447". 
      // Let's parse and ensure correct format.
      const parts = hijriDate.split('/');
      if (parts.length === 3) {
        // Assuming Intl returns dd/mm/yyyy for 'id-ID' locale
        return `${parts[0]}-${parts[1]}-${parts[2]}`;
      }
      return hijriDate.replace(/\//g, '-');
    }

    function getCurrentDate() {
      const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jum\'at', 'Sabtu'];
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      const hijriMonths = ['Muharram', 'Safar', 'Rabiul Awal', 'Rabiul Akhir', 'Jumadil Awal', 'Jumadil Akhir', 'Rajab', 'Sya\'ban', 'Ramadhan', 'Syawal', 'Dzulqa\'dah', 'Dzulhijjah'];
      
      const now = getEffectiveDate();
      const dayName = days[now.getDay()];
      
      // Gregorian Date
      const gDate = now.getDate();
      const gMonth = months[now.getMonth()];
      const gYear = now.getFullYear();
      
      // Hijri Date
      let hDateFormatted = "";
      try {
        // Apply adjustment (on top of effective date)
        const hijriDate = new Date(now);
        hijriDate.setDate(hijriDate.getDate() + (parseInt(CONFIG.hijri_adjustment) || 0));

        const hijriFormatter = new Intl.DateTimeFormat('en-u-ca-islamic-umalqura-nu-latn', {
            day: 'numeric',
            month: 'numeric',
            year: 'numeric'
        });
        const parts = hijriFormatter.formatToParts(hijriDate);
        const hDay = parts.find(p => p.type === 'day').value;
        const hMonthIndex = parseInt(parts.find(p => p.type === 'month').value) - 1;
        const hYear = parts.find(p => p.type === 'year').value;
        
        const hMonthName = hijriMonths[hMonthIndex] || '';
        hDateFormatted = `${String(hDay).padStart(2, '0')} ${hMonthName} ${hYear}`;
      } catch (e) {
        console.error("Hijri date error", e);
        hDateFormatted = ""; 
      }

      return `${dayName}, ${gDate} ${gMonth} ${gYear} M / ${hDateFormatted} H`;
    }

    function getNextPrayer() {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      const prayerTimes = getPrayerTimes();
      
      for (let prayer of prayerTimes) {
        const [hours, minutes] = prayer.time.split(':').map(Number);
        const prayerTime = hours * 60 + minutes;
        
        if (currentTime < prayerTime) {
          const diff = prayerTime - currentTime;
          const hoursLeft = Math.floor(diff / 60);
          const minutesLeft = diff % 60;
          return {
            name: prayer.name,
            timeLeft: `${String(hoursLeft).padStart(2, '0')}:${String(minutesLeft).padStart(2, '0')}`
          };
        }
      }
      
      const firstPrayer = prayerTimes[0];
      const [hours, minutes] = firstPrayer.time.split(':').map(Number);
      const prayerTime = hours * 60 + minutes;
      const diff = (24 * 60 - currentTime) + prayerTime;
      const hoursLeft = Math.floor(diff / 60);
      const minutesLeft = diff % 60;
      
      return {
        name: firstPrayer.name,
        timeLeft: `${String(hoursLeft).padStart(2, '0')}:${String(minutesLeft).padStart(2, '0')}`
      };
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
      }).format(amount);
    }

    function getSlideContent(slide, index) {
      const accentColor = CONFIG.colors.accent;
      
      if (slide.type === 'image') {
        return `
          <div class="absolute inset-0" style="background: black;">
            <img src="${slide.url}" style="width: 100%; height: 100%; object-fit: cover; opacity: 0.8;" alt="Slide ${index + 1}">
            <!-- Ayat Pilihan overlay -->
            <div class="slide-overlay">
              <div class="slide-overlay-title">
                <span class="slide-overlay-icon">üìñ</span>
                <h3>Ayat Pilihan</h3>
              </div>
              <div class="slide-overlay-text">
                ${slide.text}
              </div>
            </div>
          </div>
        `;
      }
      
      // Default SVG Themes
      if (slide.type === 'default') {
        const id = slide.id;
        if (id === 1) {
          return `
            <div class="absolute inset-0" style="background: linear-gradient(135deg, rgba(10,25,41,0.3), rgba(26,35,126,0.3));">
              <svg width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
                <defs>
                  <linearGradient id="skyGrad1" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#1a237e;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#283593;stop-opacity:1" />
                  </linearGradient>
                </defs>
                <rect width="800" height="600" fill="url(#skyGrad1)"/>
                <ellipse cx="400" cy="500" rx="300" ry="80" fill="#0d47a1" opacity="0.3"/>
                <path d="M 350 400 L 400 300 L 450 400 Z" fill="${accentColor}" opacity="0.9"/>
                <rect x="380" y="400" width="40" height="100" fill="#1a237e"/>
                <circle cx="400" cy="280" r="15" fill="${accentColor}"/>
                <path d="M 300 450 Q 300 420 320 420 L 480 420 Q 500 420 500 450 Z" fill="#1a237e"/>
                <circle cx="400" cy="150" r="60" fill="${accentColor}" opacity="0.6"/>
                <circle cx="100" cy="100" r="3" fill="white" opacity="0.8"/>
                <circle cx="150" cy="80" r="2" fill="white" opacity="0.6"/>
                <circle cx="700" cy="120" r="2.5" fill="white" opacity="0.7"/>
                <circle cx="650" cy="90" r="2" fill="white" opacity="0.5"/>
                <circle cx="200" cy="150" r="2" fill="white" opacity="0.6"/>
              </svg>
              <div class="slide-overlay">
                <div class="slide-overlay-title">
                  <span class="slide-overlay-icon">üìñ</span>
                  <h3>Ayat Pilihan</h3>
                </div>
                <div class="slide-overlay-text">
                  ${slide.text}
                </div>
              </div>
            </div>
          `;
        } else if (id === 2) {
          return `
            <div class="absolute inset-0" style="background: linear-gradient(135deg, #1a237e, #0d47a1);">
              <svg width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
                <rect width="800" height="600" fill="#0a1929"/>
                <circle cx="400" cy="300" r="180" fill="none" stroke="${accentColor}" stroke-width="2" opacity="0.3"/>
                <circle cx="400" cy="300" r="140" fill="none" stroke="${accentColor}" stroke-width="2" opacity="0.5"/>
                <rect x="320" y="240" width="160" height="120" fill="#1a1a1a" stroke="${accentColor}" stroke-width="3"/>
                <rect x="340" y="260" width="120" height="80" fill="#2a2a2a"/>
                <circle cx="150" cy="100" r="2" fill="white" opacity="0.8"/>
                <circle cx="600" cy="150" r="2" fill="white" opacity="0.7"/>
                <circle cx="200" cy="500" r="2" fill="white" opacity="0.6"/>
                <circle cx="700" cy="450" r="2" fill="white" opacity="0.8"/>
              </svg>
              <div class="slide-overlay">
                <div class="slide-overlay-title">
                  <span class="slide-overlay-icon">üìñ</span>
                  <h3>Ayat Pilihan</h3>
                </div>
                <div class="slide-overlay-text">
                  ${slide.text}
                </div>
              </div>
            </div>
          `;
        } else if (id === 3) {
          return `
            <div class="absolute inset-0" style="background: linear-gradient(135deg, #283593, #1a237e);">
              <svg width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
                <rect width="800" height="600" fill="#1a237e"/>
                <ellipse cx="400" cy="500" rx="350" ry="100" fill="#0d47a1" opacity="0.3"/>
                <path d="M 250 350 Q 250 320 270 320 L 530 320 Q 550 320 550 350 L 550 500 L 250 500 Z" fill="${accentColor}" opacity="0.2"/>
                <ellipse cx="300" cy="380" rx="30" ry="40" fill="#1a1a1a" opacity="0.6"/>
                <ellipse cx="400" cy="380" rx="30" ry="40" fill="#1a1a1a" opacity="0.6"/>
                <ellipse cx="500" cy="380" rx="30" ry="40" fill="#1a1a1a" opacity="0.6"/>
                <circle cx="100" cy="80" r="50" fill="${accentColor}" opacity="0.4"/>
              </svg>
              <div class="slide-overlay">
                <div class="slide-overlay-title">
                  <span class="slide-overlay-icon">üìñ</span>
                  <h3>Ayat Pilihan</h3>
                </div>
                <div class="slide-overlay-text">
                  ${slide.text}
                </div>
              </div>
            </div>
          `;
        } else if (id === 4) {
          return `
            <div class="absolute inset-0" style="background: linear-gradient(135deg, #0d47a1, #1565c0);">
              <svg width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
                <rect width="800" height="600" fill="#0a1929"/>
                <rect x="250" y="150" width="300" height="300" rx="10" fill="#1a1a1a" stroke="${accentColor}" stroke-width="3"/>
                <rect x="260" y="160" width="280" height="280" rx="5" fill="#2a2a2a"/>
                <line x1="400" y1="160" x2="400" y2="440" stroke="${accentColor}" stroke-width="2" opacity="0.5"/>
                <circle cx="400" cy="300" r="40" fill="${accentColor}" opacity="0.3"/>
                <path d="M 400 270 L 410 290 L 390 290 Z" fill="${accentColor}"/>
                <circle cx="120" cy="120" r="2" fill="white" opacity="0.7"/>
                <circle cx="680" cy="480" r="2" fill="white" opacity="0.7"/>
              </svg>
              <div class="slide-overlay">
                <div class="slide-overlay-title">
                  <span class="slide-overlay-icon">üìñ</span>
                  <h3>Ayat Pilihan</h3>
                </div>
                <div class="slide-overlay-text">
                  ${slide.text}
                </div>
              </div>
            </div>
          `;
        } else if (id === 5) {
          return `
            <div class="absolute inset-0" style="background: linear-gradient(135deg, #0a0e27, #1a237e);">
              <svg width="100%" height="100%" viewBox="0 0 800 600" preserveAspectRatio="xMidYMid slice">
                <rect width="800" height="600" fill="#050810"/>
                <circle cx="600" cy="150" r="70" fill="${accentColor}" opacity="0.8"/>
                <circle cx="620" cy="140" r="70" fill="#050810"/>
                <circle cx="100" cy="100" r="2" fill="white" opacity="0.9"/>
                <circle cx="150" cy="80" r="2" fill="white" opacity="0.7"/>
                <circle cx="200" cy="120" r="1.5" fill="white" opacity="0.8"/>
                <circle cx="700" cy="120" r="2.5" fill="white" opacity="0.9"/>
                <circle cx="650" cy="90" r="2" fill="white" opacity="0.6"/>
                <circle cx="300" cy="200" r="1.5" fill="white" opacity="0.7"/>
                <circle cx="450" cy="150" r="2" fill="white" opacity="0.8"/>
                <circle cx="250" cy="400" r="2" fill="white" opacity="0.7"/>
                <circle cx="600" cy="450" r="1.5" fill="white" opacity="0.8"/>
                <circle cx="350" cy="500" r="2" fill="white" opacity="0.6"/>
                <path d="M 150 500 L 200 420 L 250 500 Z" fill="#1a1a1a" opacity="0.5"/>
                <path d="M 500 500 L 550 430 L 600 500 Z" fill="#1a1a1a" opacity="0.5"/>
              </svg>
              <div class="slide-overlay">
                <div class="slide-overlay-title">
                  <span class="slide-overlay-icon">üìñ</span>
                  <h3>Ayat Pilihan</h3>
                </div>
                <div class="slide-overlay-text">
                  ${slide.text}
                </div>
              </div>
            </div>
          `;
        }
      }
      
      return '';
    }

    function renderApp() {
      const customFont = CONFIG.font_family;
      const baseFontStack = 'system-ui, -apple-system, sans-serif';
      const baseSize = getResponsiveFontSize();

      const bgColor = CONFIG.colors.background;
      const headerColor = CONFIG.colors.header;
      const accentColor = CONFIG.colors.accent;
      const textColor = CONFIG.colors.text;
      const secondaryTextColor = CONFIG.colors.secondary_text;

      const saldo = CONFIG.pemasukan - CONFIG.pengeluaran;
      const currentTime = getCurrentTime();
      const currentDate = getCurrentDate();
      const nextPrayer = getNextPrayer();
      const prayerTimes = getPrayerTimes();

      const app = document.getElementById('app');
      
      // Set CSS custom properties for colors
      document.documentElement.style.setProperty('--header-color', headerColor);
      document.documentElement.style.setProperty('--accent-color', accentColor);
      document.documentElement.style.setProperty('--text-color', textColor);
      document.documentElement.style.setProperty('--secondary-text-color', secondaryTextColor);
      document.documentElement.style.setProperty('--bg-color', bgColor);

      app.innerHTML = `
        <div class="islamic-pattern">
          <!-- Header -->
          <header class="app-header">
            <div class="header-content">
              <div class="header-logo">
                <img src="logo/logo.png" alt="Logo Masjid">
              </div>
              <div class="header-info">
                <h1 class="header-title glow-text">${CONFIG.nama_masjid}</h1>
                <div class="header-divider"></div>
                <p class="header-address">${CONFIG.alamat_masjid}</p>
              </div>
              <div class="header-date">
                <h3 id="header-date">${currentDate}</h3>
              </div>
            </div>
          </header>

          <!-- Main Content -->
          <main class="main-content">
            <!-- Left Panel - Prayer Times -->
            <aside class="prayer-panel">
              <div class="prayer-panel-header">
                <div class="prayer-panel-title">JADWAL IMSAKIYAH</div>
                <div class="prayer-panel-subtitle">HARI INI</div>
              </div>
              
              <div class="prayer-list" id="prayer-times-list">
                ${prayerTimes.map((prayer, index) => `
                  <div class="prayer-item prayer-card" data-prayer="${prayer.name}">
                    <div class="prayer-item-left">
                      <span class="prayer-icon">${prayer.icon}</span>
                      <div class="prayer-name">${prayer.name}</div>
                    </div>
                    <div class="prayer-item-right">
                      <img src="./icon/clock.png" class="prayer-clock-icon" alt="Clock">
                      <div class="prayer-time">${prayer.time}</div>
                    </div>
                  </div>
                `).join('')}
              </div>
            </aside>

            <!-- Center - Image Slider -->
            <section class="slider-panel">
              <div class="slider-container" id="imageSlider">
                ${CONFIG.slides.map((slide, index) => `
                  <div class="slide" style="opacity: ${index === 0 ? '1' : '0'};">
                    ${getSlideContent(slide, index)}
                  </div>
                `).join('')}
              </div>
              
              <div class="slide-indicators">
                ${CONFIG.slides.map((_, index) => `
                  <div class="slide-indicator ${index === 0 ? 'active' : ''}" onclick="showSlide(${index})"></div>
                `).join('')}
              </div>
            </section>

            <!-- Right Panel - Time, Countdown, Finance -->
            <aside class="right-panel">
              <!-- Current Time Display -->
              <div class="time-card prayer-card">
                <div class="time-card-label">Waktu Sekarang</div>
                <div id="right-panel-time" class="time-card-value glow-text">${currentTime}</div>
              </div>
              
              <!-- Countdown Display -->
              <div class="countdown-card prayer-card">
                <div class="countdown-content countdown-pulse">
                  <span id="right-panel-next-prayer-name" class="countdown-prayer">${nextPrayer.name}</span>
                  <img src="./icon/clock.png" class="countdown-clock" alt="Clock">
                  <span class="countdown-separator">-</span>
                  <span id="right-panel-countdown" class="countdown-value">${nextPrayer.timeLeft}</span>
                </div>
              </div>
              
              <!-- Finance Card -->
              ${CONFIG.show_finance ? `
              <div class="finance-card prayer-card">
                <div class="finance-title">Keuangan Masjid</div>
                <div class="finance-period">Periode: ${CONFIG.periode_keuangan}</div>
                <div class="finance-divider"></div>
                
                <div class="finance-grid">
                  <div class="finance-item income">
                    <div class="finance-label">Pemasukan</div>
                    <div class="finance-value income">${formatCurrency(CONFIG.pemasukan)}</div>
                  </div>
                  <div class="finance-item expense">
                    <div class="finance-label">Pengeluaran</div>
                    <div class="finance-value expense">${formatCurrency(CONFIG.pengeluaran)}</div>
                  </div>
                  <div class="finance-item balance">
                    <div class="finance-label">Saldo</div>
                    <div class="finance-value balance">${formatCurrency(saldo)}</div>
                  </div>
                </div>
                  </div>
              
              <!-- Donatur List -->
              ${(CONFIG.donatur && CONFIG.donatur.length > 0) ? `
              <div class="donatur-section">
                <div class="donatur-title">DONATUR</div>
                <div class="finance-divider"></div>
                <div class="donatur-list">
                  <div class="donatur-scroll" style="animation-duration: ${Math.max(10, CONFIG.donatur.length * 3)}s;">
                    ${CONFIG.donatur.map(d => `
                      <div class="donatur-item">
                        <div class="donatur-name">${d.nama}</div>
                        <div class="donatur-amount">${formatCurrency(d.jumlah)}</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              </div>
              ` : ''}
              </div>
              ` : ''}


            </aside>
          </main>

          <!-- Prayer Leader Tables Container -->
          <section class="petugas-container">
            <!-- Table 1: PETUGAS SHOLAT JUMAT -->
            <div class="petugas-table-wrapper">
              <h3 class="petugas-title">PETUGAS SHOLAT JUMAT</h3>
              <table class="petugas-table">
                <thead>
                  <tr>
                    <th>NO</th>
                    <th>HARI</th>
                    <th>IMAM</th>
                    <th>KHOTIB</th>
                    <th>MUADZIN</th>
                  </tr>
                </thead>
                <tbody>
                  ${(CONFIG.petugas_jumat || []).map((p, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${p.hari || 'JUMAT'}</td>
                      <td>${p.imam || '-'}</td>
                      <td>${p.khotib || '-'}</td>
                      <td>${p.muadzin || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>

            <!-- Table 2: PETUGAS SHOLAT TARAWIH -->
            <div class="petugas-table-wrapper">
              <h3 class="petugas-title">PETUGAS SHOLAT TARAWIH</h3>
              <table class="petugas-table">
                <thead>
                  <tr>
                    <th>NO</th>
                    <th>HARI</th>
                    <th>IMAM</th>
                    <th>MUADZIN</th>
                  </tr>
                </thead>
                <tbody>
                  ${(CONFIG.petugas_harian || []).map((p, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>
                        <span>${p.hari || '-'}</span>
                        <span style="margin-left: 8px; opacity: 0.8;">
                          ${p.tanggal ? 
                            `(${new Date(p.tanggal).toLocaleDateString('id-ID', {day: '2-digit', month: 'short', year: 'numeric'})} M / ${getHijriDateForDay(p.hari)} H)` :
                            `(${getGregorianDateForDay(p.hari)} M / ${getHijriDateForDay(p.hari)} H)`
                          }
                        </span>
                      </td>
                      <td>${p.imam || '-'}</td>
                      <td>${p.muadzin || '-'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          </section>

          <!-- Bottom Bar -->
          <footer class="bottom-bar">
            <div class="bottom-bar-content">
              <div class="design-by">
                Design By : MUH ICHSAN | TAHUN 2026 | HP. 081331769348
              </div>
              <div class="running-text-container">
                <div class="running-text">
                  üì¢ ${CONFIG.running_text}
                </div>
              </div>
            </div>
          </footer>

        </div>
        
        <!-- Settings Button -->
        <div id="settingsToggle" style="position: fixed; bottom: 70px; right: 20px; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; cursor: pointer;" title="Settings" onclick="openSettings()">
          <div style="width: 40px; height: 40px; background: transparent; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
            <span style="font-size: 20px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));">‚öôÔ∏è</span>
          </div>
        </div>
        
        <!-- Fullscreen Toggle Button -->
        <div id="fullscreenToggle" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; cursor: pointer;" title="Fullscreen Mode">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));">
            <path d="M7 14H5V19H10V17H7V14Z" fill="white"/>
            <path d="M5 10H7V7H10V5H5V10Z" fill="white"/>
            <path d="M17 17H14V19H19V14H17V17Z" fill="white"/>
            <path d="M14 5V7H17V10H19V5H14Z" fill="white"/>
          </svg>
        </div>
      `;
      
      // Function to toggle fullscreen
      function toggleFullscreen() {
        if (!document.fullscreenElement) {
          document.documentElement.requestFullscreen()
            .catch(err => console.error(`Error attempting to enable fullscreen: ${err.message}`));
        } else {
          if (document.exitFullscreen) {
            document.exitFullscreen();
          }
        }
      }
      
      // Show/hide buttons based on activity
      let hideButtonTimer;
      const fullscreenBtn = document.getElementById('fullscreenToggle');
      const settingsBtn = document.getElementById('settingsToggle');
      
      function showButtons() {
        if (fullscreenBtn) {
          fullscreenBtn.style.opacity = '1';
          fullscreenBtn.style.visibility = 'visible';
        }
        if (settingsBtn) {
          settingsBtn.style.opacity = '1';
          settingsBtn.style.visibility = 'visible';
        }
        
        clearTimeout(hideButtonTimer);
        hideButtonTimer = setTimeout(() => {
          if (fullscreenBtn) {
            fullscreenBtn.style.opacity = '0';
            fullscreenBtn.style.visibility = 'hidden';
          }
          if (settingsBtn) {
            settingsBtn.style.opacity = '0';
            settingsBtn.style.visibility = 'hidden';
          }
        }, 3000); // Hide after 3 seconds of inactivity
      }
      
      function hideButtons() {
        if (fullscreenBtn) {
          fullscreenBtn.style.opacity = '0';
          fullscreenBtn.style.visibility = 'hidden';
        }
        if (settingsBtn) {
          settingsBtn.style.opacity = '0';
          settingsBtn.style.visibility = 'hidden';
        }
        clearTimeout(hideButtonTimer);
      }
      
      // Add event listeners for mouse and keyboard activity
      document.addEventListener('mousemove', showButtons);
      document.addEventListener('keydown', showButtons);
      document.addEventListener('click', showButtons);
      document.addEventListener('scroll', showButtons);
      
      // Initially hide the buttons
      hideButtons();
      
      // Add click event to the fullscreen button
      if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', toggleFullscreen);
      }
      
      initializeSlider();
      initializeInfoScroller();
      startClocks();
      checkPrayerTimeInterval();
    }

    // Image Slider Logic
    let currentSlide = 0;
    let adzanMode = false;

    function showSlide(index) {
      const slides = document.querySelectorAll('.slide');
      const indicators = document.querySelectorAll('.slide-indicator');
      
      slides.forEach((slide, i) => {
        slide.style.opacity = i === index ? '1' : '0';
      });
      indicators.forEach((indicator, i) => {
        indicator.style.opacity = i === index ? '1' : '0.3';
      });
      
      currentSlide = index;
    }

    function initializeSlider() {
      const slides = document.querySelectorAll('.slide');
      const indicators = document.querySelectorAll('.slide-indicator');

      function nextSlide() {
        if (!adzanMode) {
          currentSlide = (currentSlide + 1) % slides.length;
          showSlide(currentSlide);
        }
      }

      // Auto slide every 10 seconds
      setInterval(nextSlide, 10000);
    }

    // Info scroller
    function initializeInfoScroller() {
      let infoIndex = 0;
      const infoItems = document.querySelectorAll('.info-item');
      const totalInfoItems = infoItems.length;

      function showSingleInfo() {
        if (totalInfoItems > 0) {
          infoItems.forEach((item, idx) => {
            item.style.display = 'none';
          });
          
          if (infoItems[infoIndex]) {
            infoItems[infoIndex].style.display = 'block';
          }
          
          infoIndex = (infoIndex + 1) % totalInfoItems;
        }
      }

      showSingleInfo();

      if (totalInfoItems > 1) {
        setInterval(showSingleInfo, 10000);
      }
    }

    // Clock updates
    function startClocks() {
      setInterval(() => {
        const headerTimeElement = document.getElementById('header-time');
        if (headerTimeElement) {
          headerTimeElement.textContent = getCurrentTime();
        }

        const headerDateElement = document.getElementById('header-date');
        if (headerDateElement) {
          headerDateElement.textContent = getCurrentDate();
        }

        // Update right panel time
        const rightPanelTimeElement = document.getElementById('right-panel-time');
        if (rightPanelTimeElement) {
          rightPanelTimeElement.textContent = getCurrentTime();
        }

        const countdownElement = document.getElementById('countdown');
        const nextPrayerNameElement = document.getElementById('next-prayer-name');
        if (countdownElement && nextPrayerNameElement) {
          const nextPrayer = getNextPrayer();
          countdownElement.textContent = nextPrayer.timeLeft;
          nextPrayerNameElement.textContent = nextPrayer.name;
        }

        // Update right panel countdown
        const rightPanelCountdownElement = document.getElementById('right-panel-countdown');
        const rightPanelNextPrayerNameElement = document.getElementById('right-panel-next-prayer-name');
        if (rightPanelCountdownElement && rightPanelNextPrayerNameElement) {
          const nextPrayer = getNextPrayer();
          rightPanelCountdownElement.textContent = nextPrayer.timeLeft;
          rightPanelNextPrayerNameElement.textContent = nextPrayer.name;
        }

        // Update active prayer highlight
        updateActivePrayer();
      }, 1000);
    }

    function updateActivePrayer() {
      const now = new Date();
      const currentTime = now.getHours() * 60 + now.getMinutes();
      const prayerTimes = getPrayerTimes();
      
      const prayerCards = document.querySelectorAll('#prayer-times-list .prayer-card');
      
      prayerCards.forEach((card, index) => {
        const prayer = prayerTimes[index];
        const [hours, minutes] = prayer.time.split(':').map(Number);
        const prayerTime = hours * 60 + minutes;
        
        // Check if current time is within 30 minutes after prayer time
        const timeDiff = currentTime - prayerTime;
        if (timeDiff >= 0 && timeDiff <= 30) {
          card.classList.add('active');
        } else {
          card.classList.remove('active');
        }
      });
    }

    // Prayer time checker
    function checkPrayerTime() {
      const now = new Date();
      const currentHour = String(now.getHours()).padStart(2, '0');
      const currentMinute = String(now.getMinutes()).padStart(2, '0');
      const currentTime = `${currentHour}:${currentMinute}`;
      const prayerTimes = getPrayerTimes();

      prayerTimes.forEach(prayer => {
        if (prayer.time === currentTime && !adzanMode) {
          showAdzanNotification(prayer.name, prayer.time);
        }
      });
    }

    function checkPrayerTimeInterval() {
      setInterval(checkPrayerTime, 1000);
    }

    function playBeep() {
      try {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!AudioContext) return;
        
        const audioCtx = new AudioContext();
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime); // 880Hz
        
        // Envelope
        gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
        gainNode.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 0.1);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);

        oscillator.start();
        oscillator.stop(audioCtx.currentTime + 0.5);
      } catch (e) {
        console.error("Audio play failed", e);
      }
    }

    function playAlertSound(type) {
      // Check if custom sound exists
      if (CONFIG.audio && CONFIG.audio[type]) {
        const audio = new Audio(CONFIG.audio[type]);
        audio.play().catch(e => console.error("Error playing custom audio:", e));
      } else {
        // Fallback for iqomah only
        if (type === 'iqomah') {
           playBeep();
           setTimeout(playBeep, 800);
           setTimeout(playBeep, 1600);
        }
      }
    }

    function showAdzanNotification(prayerName, prayerTime) {
      playAlertSound('adzan');
      adzanMode = true;
      
      const slides = document.querySelectorAll('.slide');
      const indicators = document.querySelectorAll('.slide-indicator');
      
      slides.forEach(slide => {
        slide.style.opacity = '0';
      });
      
      indicators.forEach(indicator => {
        indicator.style.opacity = '0';
      });

      // Create fullscreen overlay
      const adzanOverlay = document.createElement('div');
      adzanOverlay.id = 'adzanOverlay';
      adzanOverlay.className = 'adzan-overlay';

      adzanOverlay.innerHTML = `
        <div class="overlay-content">
          <div class="overlay-icon">üïå</div>
          <h1 class="overlay-title">SAATNYA ADZAN</h1>
          <div class="overlay-box">
            <div class="overlay-prayer-name">${prayerName}</div>
            <div class="overlay-prayer-time">${prayerTime}</div>
          </div>
          <div class="overlay-message">
            Di MOHON KEPADA JAMAAH UNTUK MENGISI SHOFT TERDEPAN SAMBIL MENUNGGU IQOMAH
          </div>
        </div>
      `;

      document.body.appendChild(adzanOverlay);

      const verseDisplay = document.getElementById('currentVerseDisplay');
      if (verseDisplay) {
        verseDisplay.style.opacity = '0';
        setTimeout(() => {
          verseDisplay.textContent = `‚è∞ Telah tiba waktu ${prayerName} - Segera tunaikan sholat berjamaah`;
          verseDisplay.style.opacity = '1';
        }, 500);
      }

      // Auto hide after 30 seconds and show Iqomah
      setTimeout(() => {
        hideAdzanNotification();
        showIqomahNotification();
      }, 30000);
    }

    function hideAdzanNotification() {
      const adzanOverlay = document.getElementById('adzanOverlay');
      if (adzanOverlay) {
        adzanOverlay.remove();
      }
    }

    function showIqomahNotification() {
      adzanMode = true;
      
      // Create fullscreen overlay
      const iqomahOverlay = document.createElement('div');
      iqomahOverlay.id = 'iqomahOverlay';
      iqomahOverlay.className = 'iqomah-overlay';

      let iqomahCountdown = 600;
      
      iqomahOverlay.innerHTML = `
        <div class="overlay-content">
          <div class="overlay-icon">üïå</div>
          <h1 class="overlay-title">IQOMAH</h1>
          <div class="overlay-box">
            <div class="overlay-prayer-name" style="font-size: clamp(1rem, 4vw, 1.5rem);">Hitung Mundur Menuju Waktu Iqomah</div>
            <div class="countdown-pulse" style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 1rem;">
              <span style="font-size: clamp(1.5rem, 5vw, 2rem);">‚è∞</span>
              <span id="iqomahCountdown" class="overlay-prayer-time" style="font-size: clamp(2.5rem, 10vw, 4rem);">10:00</span>
            </div>
          </div>
          <div class="overlay-message" style="margin-top: 2rem;">
            SAATNYA MENDIRIKAN SHOLAT
          </div>
          <div class="overlay-message" style="margin-top: 0.5rem; font-size: clamp(0.875rem, 3vw, 1.25rem);">
            LURUSKAN DAN RAPATKAN SHOFT 
          </div>
        </div>
      `;

      document.body.appendChild(iqomahOverlay);

      const verseDisplay = document.getElementById('currentVerseDisplay');
      if (verseDisplay) {
        verseDisplay.style.opacity = '0';
        setTimeout(() => {
          verseDisplay.textContent = 'üïå Persiapkan diri untuk sholat berjamaah - Luruskan dan rapatkan shaf';
          verseDisplay.style.opacity = '1';
        }, 500);
      }

      const iqomahInterval = setInterval(() => {
        iqomahCountdown--;
        
        const minutes = Math.floor(iqomahCountdown / 60);
        const seconds = iqomahCountdown % 60;
        const countdownDisplay = document.getElementById('iqomahCountdown');
        
        if (countdownDisplay) {
          countdownDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        if (iqomahCountdown <= 0) {
          clearInterval(iqomahInterval);
          playAlertSound('iqomah');
          hideIqomahNotification();
        }
      }, 1000);
    }

    function hideIqomahNotification() {
      adzanMode = false;
      const iqomahOverlay = document.getElementById('iqomahOverlay');
      if (iqomahOverlay) {
        iqomahOverlay.remove();
      }
      
      const slides = document.querySelectorAll('.slide');
      const indicators = document.querySelectorAll('.slide-indicator');
      
      slides[currentSlide].style.opacity = '1';
      indicators.forEach((indicator, i) => {
        indicator.style.opacity = i === currentSlide ? '1' : '0.3';
      });
    }

    // ============================================
    // SETTINGS MENU LOGIC
    // ============================================

    window.applyResolutionPreset = function(mode) {
      const fontSizeInput = document.getElementById('input_font_size');
      if (mode === 'hd') {
        if (fontSizeInput) fontSizeInput.value = 14;
      } else if (mode === 'fhd') {
        if (fontSizeInput) fontSizeInput.value = 18;
      } else if (mode === '4k') {
        if (fontSizeInput) fontSizeInput.value = 36;
      }
    };

    window.applyTheme = function(themeId) {
      const theme = THEMES.find(t => t.id === themeId);
      if (theme) {
        const updateColor = (key, value) => {
           const textInput = document.getElementById('color_' + key);
           const pickerInput = document.getElementById('color_' + key + '_picker');
           if (textInput) textInput.value = value;
           if (pickerInput) pickerInput.value = value;
        };
        
        updateColor('background', theme.colors.background);
        updateColor('header', theme.colors.header);
        updateColor('accent', theme.colors.accent);
        updateColor('text', theme.colors.text);
        updateColor('secondary_text', theme.colors.secondary_text);
      }
    };

    function openSettings() {
      // Prevent multiple modals
      if (document.getElementById('settingsModal')) return;

      const modal = document.createElement('div');
      modal.id = 'settingsModal';
      modal.style.cssText = `
        position: fixed; 
        inset: 0; 
        background: rgba(0,0,0,0.85); 
        z-index: 2000; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        padding: 20px;
        backdrop-filter: blur(5px);
      `;
      
      const accentColor = CONFIG.colors.accent;
      const headerColor = CONFIG.colors.header;
      
      let slidesHtml = '';
      CONFIG.slides.forEach((slide, index) => {
        slidesHtml += `
          <div class="slide-input-group" style="background: rgba(255,255,255,0.05); padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <label style="color: ${accentColor}; font-weight: bold;">Slide ${index + 1}</label>
              ${CONFIG.slides.length > 1 ? `<button type="button" onclick="removeSlide(${index})" style="color: #ff4444; background: none; border: none; cursor: pointer;">üóëÔ∏è Hapus</button>` : ''}
            </div>
            
            <!-- Image Source Selection -->
            <div style="margin-bottom: 8px;">
               <label style="display: block; color: #ccc; font-size: 12px; margin-bottom: 2px;">Sumber Gambar</label>
               <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                 <input type="text" name="slide_url_${index}" value="${slide.type === 'image' && !slide.url.startsWith('data:') ? slide.url : ''}" placeholder="URL Gambar (https://...)" style="flex: 1; padding: 5px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; border-radius: 4px;">
                 <span style="color: #aaa; align-self: center;">atau</span>
                 <div style="flex: 1; position: relative;">
                   <input type="file" id="file_input_${index}" accept="image/*" style="width: 100%; color: #aaa; font-size: 12px;">
                 </div>
               </div>
               ${slide.type === 'image' ? `
                 <div style="margin-top: 5px; display: flex; align-items: center; gap: 10px;">
                   <span style="color: #888; font-size: 11px;">Preview saat ini:</span>
                   <img src="${slide.url}" style="height: 30px; border-radius: 4px; border: 1px solid #555;">
                   <input type="hidden" name="slide_existing_data_${index}" value="${slide.url}">
                 </div>
               ` : ''}
            </div>

            <div>
              <label style="display: block; color: #ccc; font-size: 12px; margin-bottom: 2px;">Teks / Ayat</label>
              <textarea name="slide_text_${index}" rows="3" style="width: 100%; padding: 5px; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; border-radius: 4px;">${slide.text}</textarea>
            </div>
            <input type="hidden" name="slide_type_${index}" value="${slide.type}">
            <input type="hidden" name="slide_id_${index}" value="${slide.id || 0}">
          </div>
        `;
      });

      modal.innerHTML = `
        <div style="background: #1a1a1a; width: 100%; max-width: 800px; height: 90vh; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; border: 1px solid ${accentColor}; box-shadow: 0 0 20px rgba(0,0,0,0.5);">
          <!-- Header -->
          <div style="padding: 15px 20px; background: ${headerColor}; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333;">
            <h2 style="color: white; font-weight: bold; font-size: 18px;">‚öôÔ∏è Pengaturan Jadwal Sholat</h2>
            <button onclick="closeSettings()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">&times;</button>
          </div>
          
          <!-- Content -->
          <div style="flex: 1; overflow-y: auto; padding: 20px;">
            <form id="settingsForm" onsubmit="saveSettings(event)">
              
              <!-- Informasi Masjid -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">1. Informasi Masjid</h3>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 10px;">
                <div>
                  <label style="display: block; color: #aaa; margin-bottom: 5px;">Nama Masjid</label>
                  <input type="text" name="nama_masjid" value="${CONFIG.nama_masjid}" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                </div>
                <div>
                  <label style="display: block; color: #aaa; margin-bottom: 5px;">Alamat</label>
                  <input type="text" name="alamat_masjid" value="${CONFIG.alamat_masjid}" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                </div>
              </div>
              
              <!-- Hijri Adjustment -->
              <div style="margin-bottom: 10px;">
                <label style="display: block; color: #aaa; margin-bottom: 5px;">Koreksi Tanggal Hijriyah (Hari)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="number" name="hijri_adjustment" value="${CONFIG.hijri_adjustment || 0}" style="width: 100px; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                  <span style="font-size: 12px; color: #888;">Isi 1, 2, -1, atau -2 untuk menyesuaikan tanggal.</span>
                </div>
              </div>

              <!-- Gregorian Adjustment -->
              <div style="margin-bottom: 10px;">
                <label style="display: block; color: #aaa; margin-bottom: 5px;">Koreksi Tanggal Masehi (Hari)</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <input type="number" name="gregorian_adjustment" value="${CONFIG.gregorian_adjustment || 0}" style="width: 100px; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                  <span style="font-size: 12px; color: #888;">Gunakan jika tanggal sistem salah.</span>
                </div>
              </div>

              <!-- Logo Masjid Input -->
              <div style="margin-bottom: 20px;">
                <label style="display: block; color: #aaa; margin-bottom: 5px;">Logo Masjid</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  ${CONFIG.logo ? `<img src="${CONFIG.logo}" style="width: 40px; height: 40px; object-fit: contain; background: rgba(255,255,255,0.1); padding: 2px; border-radius: 4px;">` : ''}
                  <div style="flex: 1;">
                     <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                       <input type="text" name="logo_url" value="${CONFIG.logo && !CONFIG.logo.startsWith('data:') ? CONFIG.logo : ''}" placeholder="URL Logo (https://...)" style="flex: 1; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                       <span style="color: #aaa; align-self: center;">atau</span>
                       <div style="flex: 1; position: relative;">
                         <input type="file" id="logo_file_input" accept="image/*" style="width: 100%; color: #aaa; font-size: 12px;">
                       </div>
                     </div>
                     <div style="font-size: 11px; color: #666;">*Biarkan kosong jika ingin menggunakan logo default</div>
                  </div>
                  <button type="button" onclick="resetLogo()" style="color: #ff4444; background: none; border: 1px solid #ff4444; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">Hapus Logo</button>
                </div>
              </div>

              <!-- Waktu Sholat -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">2. Waktu Sholat (HH:MM)</h3>
              
              <!-- Visibility Options -->
              <div style="display: flex; gap: 20px; margin-bottom: 15px;">
                <label style="display: flex; align-items: center; gap: 8px; color: white; cursor: pointer;">
                  <input type="checkbox" name="tampilkan_imsak" ${CONFIG.tampilkan_imsak ? 'checked' : ''} style="accent-color: ${accentColor}; width: 16px; height: 16px;">
                  Tampilkan Imsak
                </label>
                <label style="display: flex; align-items: center; gap: 8px; color: white; cursor: pointer;">
                  <input type="checkbox" name="tampilkan_dhuha" ${CONFIG.tampilkan_dhuha ? 'checked' : ''} style="accent-color: ${accentColor}; width: 16px; height: 16px;">
                  Tampilkan Dhuha
                </label>
              </div>

              <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px;">
                ${Object.entries(CONFIG.waktu_sholat).map(([key, val]) => `
                  <div>
                    <label style="display: block; color: #aaa; margin-bottom: 5px; text-transform: capitalize;">${key === 'dhuhur' ? "Dhuhur / Jum'at" : key}</label>
                    <input type="time" name="waktu_${key}" value="${val}" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                  </div>
                `).join('')}
              </div>

              <!-- Pengumuman -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">4. Pengumuman</h3>
              <div style="display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px;">
                <div>
                  <label style="display: block; color: #aaa; margin-bottom: 5px;">Info 1</label>
                  <textarea name="info_1" rows="2" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">${CONFIG.info_1 || ''}</textarea>
                </div>
                <div>
                  <label style="display: block; color: #aaa; margin-bottom: 5px;">Info 2</label>
                  <textarea name="info_2" rows="2" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">${CONFIG.info_2 || ''}</textarea>
                </div>
                <div>
                  <label style="display: block; color: #aaa; margin-bottom: 5px;">Info 3</label>
                  <textarea name="info_3" rows="2" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">${CONFIG.info_3 || ''}</textarea>
                </div>
              </div>

              <!-- Pengaturan Tampilan -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">5. Pengaturan Tampilan</h3>
              <div style="margin-bottom: 20px;">
                <label style="display: flex; align-items: center; gap: 8px; color: white; cursor: pointer; margin-bottom: 10px;">
                  <input type="checkbox" name="show_finance" ${CONFIG.show_finance ? 'checked' : ''} style="accent-color: ${accentColor}; width: 16px; height: 16px;">
                  Tampilkan Keuangan Masjid dan Donatur
                </label>
                <div style="font-size: 12px; color: #888; margin-left: 24px;">Centang untuk menampilkan kontainer keuangan dan daftar donatur di panel kanan</div>
              </div>

              <!-- Petugas Sholat Jumat -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">Petugas Sholat Jumat</h3>
              <div id="petugas-jumat-container" style="margin-bottom: 20px;">
                ${(CONFIG.petugas_jumat || []).map((p, index) => `
                  <div class="petugas-jumat-item" style="display: grid; grid-template-columns: 0.5fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">
                    <div>
                      <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 3px;">Hari</label>
                      <input type="text" class="petugas-jumat-hari" value="${p.hari || 'JUMAT'}" placeholder="Hari" style="width: 100%; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 3px;">Imam</label>
                      <input type="text" class="petugas-jumat-imam" value="${p.imam || ''}" placeholder="Nama Imam" style="width: 100%; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 3px;">Khotib</label>
                      <input type="text" class="petugas-jumat-khotib" value="${p.khotib || ''}" placeholder="Nama Khotib" style="width: 100%; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 3px;">Muadzin</label>
                      <input type="text" class="petugas-jumat-muadzin" value="${p.muadzin || ''}" placeholder="Nama Muadzin" style="width: 100%; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                    </div>
                  </div>
                `).join('')}
              </div>


              <!-- PETUGAS SHOLAT TARAWIH -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">PETUGAS SHOLAT TARAWIH</h3>
              <div id="petugas-harian-container" style="margin-bottom: 20px;">
                ${(CONFIG.petugas_harian || []).map((p, index) => `
                  <div class="petugas-harian-item" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; align-items: center; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">
                    <div>
                      <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 3px;">Hari</label>
                      <select class="petugas-harian-hari" style="width: 100%; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                        <option value="SENIN" ${p.hari === 'SENIN' ? 'selected' : ''}>SENIN</option>
                        <option value="SELASA" ${p.hari === 'SELASA' ? 'selected' : ''}>SELASA</option>
                        <option value="RABU" ${p.hari === 'RABU' ? 'selected' : ''}>RABU</option>
                        <option value="KAMIS" ${p.hari === 'KAMIS' ? 'selected' : ''}>KAMIS</option>
                        <option value="JUMAT" ${p.hari === 'JUMAT' ? 'selected' : ''}>JUMAT</option>
                        <option value="SABTU" ${p.hari === 'SABTU' ? 'selected' : ''}>SABTU</option>
                        <option value="AHAD" ${p.hari === 'AHAD' ? 'selected' : ''}>AHAD</option>
                      </select>
                    </div>
                    <div>
                      <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 3px;">Tanggal</label>
                      <input type="date" class="petugas-harian-tanggal" value="${p.tanggal || ''}" style="width: 100%; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 3px;">Imam</label>
                      <input type="text" class="petugas-harian-imam" value="${p.imam || ''}" placeholder="Nama Imam" style="width: 100%; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                    </div>
                    <div>
                      <label style="display: block; color: #aaa; font-size: 12px; margin-bottom: 3px;">Muadzin</label>
                      <input type="text" class="petugas-harian-muadzin" value="${p.muadzin || ''}" placeholder="Nama Muadzin" style="width: 100%; padding: 6px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                    </div>
                  </div>
                `).join('')}
              </div>
              
              <!-- Excel Template Management -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">Excel Template Management</h3>
              <div style="margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; margin-bottom: 15px;">
                  <button type="button" onclick="downloadPrayerScheduleTemplate()" style="flex: 1; background: ${accentColor}; color: #000; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">
                    üì• Download Template Excel
                  </button>
                  <div style="flex: 1; position: relative;">
                    <input type="file" id="excel-upload-input" accept=".xlsx,.xls" style="width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; cursor: pointer;" onchange="handleExcelUpload(this)">
                    <div style="font-size: 11px; color: #666; margin-top: 5px;">Pilih file Excel dengan format template</div>
                  </div>
                </div>
                <div style="font-size: 12px; color: #888;">
                  Gunakan template yang diunduh untuk mengisi jadwal sholat, lalu unggah kembali untuk memperbarui jadwal.
                </div>
              </div>
              
                            
              <!-- Running Text -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">5. Running Text Bawah</h3>
              <div style="margin-bottom: 20px;">
                <textarea name="running_text" rows="3" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">${CONFIG.running_text}</textarea>
              </div>

              <!-- Audio Settings -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">6. Suara Adzan & Iqomah</h3>
              <div style="margin-bottom: 20px; background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px;">
                 <div style="margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;">
                   <label style="display: block; color: #aaa; margin-bottom: 8px; font-weight: bold;">üîä Suara Adzan (WAV/MP3)</label>
                   <div style="display: flex; flex-direction: column; gap: 10px;">
                     <div style="display: flex; gap: 10px; align-items: center;">
                       <input type="file" id="audio_adzan_input" accept="audio/*" style="flex: 1; color: #aaa; font-size: 12px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; border: 1px solid #444;">
                     </div>
                     ${CONFIG.audio && CONFIG.audio.adzan ? `
                        <div style="display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;">
                          <span style="color: #888; font-size: 11px;">Saat ini:</span>
                          <audio controls src="${CONFIG.audio.adzan}" style="height: 30px; width: 200px;"></audio>
                          <button type="button" onclick="clearAudio('adzan')" style="color: #ff4444; background: none; border: 1px solid #ff4444; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">üóëÔ∏è Hapus</button>
                        </div>
                     ` : '<div style="color: #666; font-size: 12px; font-style: italic;">* Belum ada suara kustom (Hening)</div>'}
                   </div>
                 </div>
                 <div>
                   <label style="display: block; color: #aaa; margin-bottom: 8px; font-weight: bold;">üîî Suara Iqomah (WAV/MP3)</label>
                   <div style="display: flex; flex-direction: column; gap: 10px;">
                     <div style="display: flex; gap: 10px; align-items: center;">
                       <input type="file" id="audio_iqomah_input" accept="audio/*" style="flex: 1; color: #aaa; font-size: 12px; background: rgba(0,0,0,0.3); padding: 8px; border-radius: 4px; border: 1px solid #444;">
                     </div>
                     ${CONFIG.audio && CONFIG.audio.iqomah ? `
                        <div style="display: flex; gap: 10px; align-items: center; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px;">
                          <span style="color: #888; font-size: 11px;">Saat ini:</span>
                          <audio controls src="${CONFIG.audio.iqomah}" style="height: 30px; width: 200px;"></audio>
                          <button type="button" onclick="clearAudio('iqomah')" style="color: #ff4444; background: none; border: 1px solid #ff4444; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">üóëÔ∏è Hapus</button>
                        </div>
                     ` : '<div style="color: #666; font-size: 12px; font-style: italic;">* Default: Bunyi Beep 3x</div>'}
                   </div>
                 </div>
              </div>

              <!-- Tampilan & Tema -->
              <h3 style="color: ${accentColor}; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">7. Tampilan & Tema</h3>
              <div style="margin-bottom: 20px;">
                <!-- Resolusi & Font -->
                <div style="margin-bottom: 15px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px;">
                  <label style="display: block; color: #aaa; margin-bottom: 10px; font-size: 12px; font-weight: bold;">Resolusi & Ukuran Teks</label>
                  
                  <div style="margin-bottom: 10px;">
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 11px;">Preset Resolusi TV</label>
                    <select name="resolusi" onchange="applyResolutionPreset(this.value)" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                      <option value="hd" ${CONFIG.resolusi === 'hd' ? 'selected' : ''}>HD (1280x720) - Font Kecil</option>
                      <option value="fhd" ${CONFIG.resolusi === 'fhd' ? 'selected' : ''}>Full HD (1920x1080) - Font Sedang</option>
                      <option value="4k" ${CONFIG.resolusi === '4k' ? 'selected' : ''}>4K Ultra HD (3840x2160) - Font Besar</option>
                    </select>
                  </div>

                  <div style="margin-bottom: 10px;">
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 11px;">Rasio Layar (Aspect Ratio)</label>
                    <select name="aspect_ratio" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                      <option value="16:9" ${CONFIG.aspect_ratio === '16:9' ? 'selected' : ''}>16:9 (TV/Monitor Standar)</option>
                      <option value="18:9" ${CONFIG.aspect_ratio === '18:9' ? 'selected' : ''}>18:9 (HP Full Screen)</option>
                      <option value="19:9" ${CONFIG.aspect_ratio === '19:9' ? 'selected' : ''}>19:9 (HP Modern)</option>
                      <option value="20:9" ${CONFIG.aspect_ratio === '20:9' ? 'selected' : ''}>20:9 (HP Ultra Wide)</option>
                      <option value="21:9" ${CONFIG.aspect_ratio === '21:9' ? 'selected' : ''}>21:9 (Ultrawide Monitor)</option>
                    </select>
                  </div>

                  <div>
                    <label style="display: block; color: #888; margin-bottom: 5px; font-size: 11px;">Ukuran Font Dasar (px)</label>
                    <input type="number" name="font_size" id="input_font_size" value="${CONFIG.font_size}" style="width: 100%; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
                  </div>
                </div>

                <label style="display: block; color: #aaa; margin-bottom: 10px;">Pilih Tema Warna</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-bottom: 15px;">
                  ${THEMES.map(theme => `
                    <div onclick="applyTheme('${theme.id}')" style="cursor: pointer; border: 1px solid #444; border-radius: 8px; overflow: hidden; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                      <div style="height: 40px; background: linear-gradient(135deg, ${theme.colors.header}, ${theme.colors.background}); display: flex; align-items: center; justify-content: center;">
                        <div style="width: 15px; height: 15px; background: ${theme.colors.accent}; border-radius: 50%; border: 1px solid rgba(255,255,255,0.5);"></div>
                      </div>
                      <div style="padding: 6px; background: #2a2a2a; text-align: center;">
                        <span style="color: white; font-size: 11px; font-weight: bold;">${theme.name}</span>
                      </div>
                    </div>
                  `).join('')}
                </div>

                <div style="background: rgba(255,255,255,0.03); padding: 10px; border-radius: 8px;">
                  <label style="display: block; color: #aaa; margin-bottom: 10px; font-size: 12px; font-weight: bold;">Kustomisasi Warna (Manual)</label>
                  <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                     <div>
                       <label style="color: #888; font-size: 11px;">Background (Dasar)</label>
                       <div style="display: flex; gap: 5px;">
                         <input type="color" id="color_background_picker" value="${CONFIG.colors.background}" onchange="document.getElementById('color_background').value = this.value" style="width: 30px; height: 30px; border: none; padding: 0; background: none; cursor: pointer;">
                         <input type="text" name="color_background" id="color_background" value="${CONFIG.colors.background}" style="flex: 1; background: #2a2a2a; border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; font-size: 12px;" onchange="document.getElementById('color_background_picker').value = this.value">
                       </div>
                     </div>
                     <div>
                       <label style="color: #888; font-size: 11px;">Header (Atas)</label>
                       <div style="display: flex; gap: 5px;">
                         <input type="color" id="color_header_picker" value="${CONFIG.colors.header}" onchange="document.getElementById('color_header').value = this.value" style="width: 30px; height: 30px; border: none; padding: 0; background: none; cursor: pointer;">
                         <input type="text" name="color_header" id="color_header" value="${CONFIG.colors.header}" style="flex: 1; background: #2a2a2a; border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; font-size: 12px;" onchange="document.getElementById('color_header_picker').value = this.value">
                       </div>
                     </div>
                     <div>
                       <label style="color: #888; font-size: 11px;">Accent (Aksen/Highlight)</label>
                       <div style="display: flex; gap: 5px;">
                         <input type="color" id="color_accent_picker" value="${CONFIG.colors.accent}" onchange="document.getElementById('color_accent').value = this.value" style="width: 30px; height: 30px; border: none; padding: 0; background: none; cursor: pointer;">
                         <input type="text" name="color_accent" id="color_accent" value="${CONFIG.colors.accent}" style="flex: 1; background: #2a2a2a; border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; font-size: 12px;" onchange="document.getElementById('color_accent_picker').value = this.value">
                       </div>
                     </div>
                     <div>
                       <label style="color: #888; font-size: 11px;">Text Utama</label>
                       <div style="display: flex; gap: 5px;">
                         <input type="color" id="color_text_picker" value="${CONFIG.colors.text}" onchange="document.getElementById('color_text').value = this.value" style="width: 30px; height: 30px; border: none; padding: 0; background: none; cursor: pointer;">
                         <input type="text" name="color_text" id="color_text" value="${CONFIG.colors.text}" style="flex: 1; background: #2a2a2a; border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; font-size: 12px;" onchange="document.getElementById('color_text_picker').value = this.value">
                       </div>
                     </div>
                     <div>
                       <label style="color: #888; font-size: 11px;">Text Sekunder</label>
                       <div style="display: flex; gap: 5px;">
                         <input type="color" id="color_secondary_text_picker" value="${CONFIG.colors.secondary_text}" onchange="document.getElementById('color_secondary_text').value = this.value" style="width: 30px; height: 30px; border: none; padding: 0; background: none; cursor: pointer;">
                         <input type="text" name="color_secondary_text" id="color_secondary_text" value="${CONFIG.colors.secondary_text}" style="flex: 1; background: #2a2a2a; border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; font-size: 12px;" onchange="document.getElementById('color_secondary_text_picker').value = this.value">
                       </div>
                     </div>
                  </div>
                </div>
              </div>

              <!-- Slide Images & Text -->
              <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 15px;">
                <h3 style="color: ${accentColor}; margin: 0;">8. Gambar & Teks Slide</h3>
                <button type="button" onclick="addSlide()" style="background: ${accentColor}; color: #000; border: none; padding: 5px 10px; border-radius: 4px; font-weight: bold; cursor: pointer;">+ Tambah Slide</button>
              </div>
              <div id="slides-container" style="margin-bottom: 20px;">
                ${slidesHtml}
              </div>

              <!-- Actions -->
              <div style="display: flex; gap: 10px; margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">
                <button type="submit" style="flex: 1; background: ${accentColor}; color: #000; border: none; padding: 12px; border-radius: 6px; font-weight: bold; font-size: 16px; cursor: pointer;">üíæ Simpan Pengaturan</button>
                <button type="button" onclick="resetConfig()" style="background: #ff4444; color: white; border: none; padding: 12px; border-radius: 6px; font-weight: bold; cursor: pointer;">‚Üª Reset Default</button>
              </div>

            </form>
          </div>
        </div>
      `;

      document.body.appendChild(modal);
    }

    function closeSettings() {
      const modal = document.getElementById('settingsModal');
      if (modal) modal.remove();
    }

    function addSlide() {
      const newSlide = { type: 'image', url: '', text: 'Teks Baru' };
      CONFIG.slides.push(newSlide);
      closeSettings();
      openSettings();
    }

    window.addDonatur = function() {
      const container = document.getElementById('donatur-container');
      const div = document.createElement('div');
      div.className = 'donatur-item';
      div.style.cssText = 'display: flex; gap: 10px; margin-bottom: 10px; align-items: center;';
      div.innerHTML = `
        <input type="text" class="donatur-nama" placeholder="Nama Donatur" style="flex: 2; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
        <input type="number" class="donatur-jumlah" placeholder="Jumlah" style="flex: 1; padding: 8px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px;">
        <button type="button" onclick="this.parentElement.remove()" style="color: #ff4444; background: none; border: 1px solid #ff4444; padding: 4px 8px; border-radius: 4px; cursor: pointer;">üóëÔ∏è</button>
      `;
      container.appendChild(div);
    };


    window.hapusPetugasJumat = function(index) {
      if (confirm('Hapus petugas jumat ini?')) {
        CONFIG.petugas_jumat.splice(index, 1);
        closeSettings();
        openSettings();
      }
    };



    window.hapusPetugasHarian = function(index) {
      if (confirm('Hapus petugas harian ini?')) {
        CONFIG.petugas_harian.splice(index, 1);
        closeSettings();
        openSettings();
      }
    };

    function removeSlide(index) {
      if (confirm('Hapus slide ini?')) {
        CONFIG.slides.splice(index, 1);
        closeSettings();
        openSettings();
      }
    }

    function clearAudio(type) {
      if (confirm(`Hapus audio kustom untuk ${type}?`)) {
        if (CONFIG.audio) {
          CONFIG.audio[type] = DEFAULT_CONFIG.audio[type];
          localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
          closeSettings();
          openSettings();
        }
      }
    }

    function resetLogo() {
      if (confirm('Hapus logo kustom dan kembali ke default?')) {
        CONFIG.logo = null;
        localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
        closeSettings();
        openSettings();
      }
    }

    function resetConfig() {
      if (confirm('Kembalikan ke pengaturan awal? Semua perubahan akan hilang.')) {
        localStorage.removeItem('mosqueConfig');
        location.reload();
      }
    }

    async function saveSettings(e) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);

      // Update Basic Info
      CONFIG.nama_masjid = formData.get('nama_masjid');
      CONFIG.alamat_masjid = formData.get('alamat_masjid');
      CONFIG.hijri_adjustment = parseInt(formData.get('hijri_adjustment')) || 0;
      CONFIG.gregorian_adjustment = parseInt(formData.get('gregorian_adjustment')) || 0;
      CONFIG.resolusi = formData.get('resolusi');
      CONFIG.aspect_ratio = formData.get('aspect_ratio') || "16:9";
      CONFIG.font_size = parseInt(formData.get('font_size')) || 24;
      
      // Update Logo
      const logoFile = document.getElementById('logo_file_input').files[0];
      const logoUrl = formData.get('logo_url');
      
      if (logoFile) {
        try {
           CONFIG.logo = await readFileAsDataURL(logoFile);
        } catch (err) {
           console.error("Error reading logo file:", err);
        }
      } else if (logoUrl && logoUrl.trim() !== '') {
        CONFIG.logo = logoUrl;
      }
      
      // Update Prayer Times
      CONFIG.waktu_sholat.imsak = formData.get('waktu_imsak');
      CONFIG.waktu_sholat.subuh = formData.get('waktu_subuh');
      CONFIG.waktu_sholat.dhuha = formData.get('waktu_dhuha');
      CONFIG.waktu_sholat.dhuhur = formData.get('waktu_dhuhur');
      CONFIG.waktu_sholat.ashar = formData.get('waktu_ashar');
      CONFIG.waktu_sholat.maghrib = formData.get('waktu_maghrib');
      CONFIG.waktu_sholat.isya = formData.get('waktu_isya');

      CONFIG.tampilkan_imsak = formData.get('tampilkan_imsak') === 'on';
      CONFIG.tampilkan_dhuha = formData.get('tampilkan_dhuha') === 'on';
      CONFIG.show_finance = formData.get('show_finance') === 'on';

      // Update Finance
      CONFIG.periode_keuangan = formData.get('periode_keuangan');
      CONFIG.pemasukan = parseInt(formData.get('pemasukan'));
      CONFIG.pengeluaran = parseInt(formData.get('pengeluaran'));

      // Update Donatur
      const donaturItems = document.querySelectorAll('.donatur-item');
      CONFIG.donatur = Array.from(donaturItems).map(item => {
        return {
          nama: item.querySelector('.donatur-nama').value,
          jumlah: parseInt(item.querySelector('.donatur-jumlah').value) || 0
        };
      }).filter(d => d.nama.trim() !== '');

      // Update Petugas Sholat Jumat
      const petugasJumatItems = document.querySelectorAll('.petugas-jumat-item');
      CONFIG.petugas_jumat = Array.from(petugasJumatItems).map(item => {
        return {
          hari: item.querySelector('.petugas-jumat-hari').value || 'JUMAT',
          imam: item.querySelector('.petugas-jumat-imam').value,
          khotib: item.querySelector('.petugas-jumat-khotib').value,
          muadzin: item.querySelector('.petugas-jumat-muadzin').value
        };
      }).filter(p => p.imam.trim() !== '' || p.khotib.trim() !== '' || p.muadzin.trim() !== '');

      // Update PETUGAS SHOLAT TARAWIH
      const petugasHarianItems = document.querySelectorAll('.petugas-harian-item');
      CONFIG.petugas_harian = Array.from(petugasHarianItems).map(item => {
        return {
          hari: item.querySelector('.petugas-harian-hari').value,
          tanggal: item.querySelector('.petugas-harian-tanggal').value,
          imam: item.querySelector('.petugas-harian-imam').value,
          muadzin: item.querySelector('.petugas-harian-muadzin').value
        };
      }).filter(p => p.hari && (p.imam.trim() !== '' || p.muadzin.trim() !== ''));

      // Update Info
      CONFIG.info_1 = formData.get('info_1');
      CONFIG.info_2 = formData.get('info_2');
      CONFIG.info_3 = formData.get('info_3');
      CONFIG.running_text = formData.get('running_text');

      // Update Colors
      CONFIG.colors.background = formData.get('color_background');
      CONFIG.colors.header = formData.get('color_header');
      CONFIG.colors.accent = formData.get('color_accent');
      CONFIG.colors.text = formData.get('color_text');
      CONFIG.colors.secondary_text = formData.get('color_secondary_text');

      // Update Audio
      const adzanFile = document.getElementById('audio_adzan_input').files[0];
      const iqomahFile = document.getElementById('audio_iqomah_input').files[0];

      if (adzanFile) {
        try {
          CONFIG.audio.adzan = await readFileAsDataURL(adzanFile);
        } catch (err) {
          console.error("Error reading adzan file:", err);
          alert("Gagal membaca file Adzan: " + err.message);
        }
      }

      if (iqomahFile) {
        try {
           CONFIG.audio.iqomah = await readFileAsDataURL(iqomahFile);
        } catch (err) {
           console.error("Error reading iqomah file:", err);
           alert("Gagal membaca file Iqomah: " + err.message);
        }
      }

      // Update Slides
      const newSlides = [];
      const slideContainers = document.querySelectorAll('.slide-input-group');
      
      const slidePromises = Array.from(slideContainers).map(async (container, index) => {
        const url = formData.get(`slide_url_${index}`);
        const text = formData.get(`slide_text_${index}`);
        const type = formData.get(`slide_type_${index}`);
        const id = formData.get(`slide_id_${index}`);
        const existingData = formData.get(`slide_existing_data_${index}`);
        const fileInput = document.getElementById(`file_input_${index}`);
        
        let slide = {
          text: text
        };

        // Priority: 1. New File, 2. URL Input, 3. Existing Data (if type was image), 4. Default
        
        if (fileInput && fileInput.files && fileInput.files[0]) {
          // Process uploaded file
          try {
            const base64 = await readFileAsDataURL(fileInput.files[0]);
            slide.type = 'image';
            slide.url = base64;
          } catch (err) {
            console.error("Error reading file:", err);
            // Fallback to existing or url
            if (url && url.trim() !== '') {
               slide.type = 'image';
               slide.url = url;
            } else if (existingData) {
               slide.type = 'image';
               slide.url = existingData;
            }
          }
        } else if (url && url.trim() !== '') {
          slide.type = 'image';
          slide.url = url;
        } else if (existingData) {
           // User didn't change anything, keep existing image
           slide.type = 'image';
           slide.url = existingData;
        } else {
          // If no image source, check if it was a default slide
          if (type === 'default') {
            slide.type = 'default';
            slide.id = parseInt(id);
          } else {
            // It was an image slide but now cleared? Or a new slide with no image?
            // Default to image type but empty (black screen) or maybe switch to default style if we could?
            // Let's just keep it as image with empty url (black background)
            slide.type = 'image';
            slide.url = ''; 
          }
        }
        
        return slide;
      });
      
      CONFIG.slides = await Promise.all(slidePromises);

      // Save to LocalStorage
      try {
        localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
        alert('Pengaturan berhasil disimpan!');
        location.reload();
      } catch (e) {
        if (e.name === 'QuotaExceededError') {
          alert('Gagal menyimpan: Ukuran gambar terlalu besar. Coba gunakan gambar yang lebih kecil.');
        } else {
          alert('Terjadi kesalahan saat menyimpan pengaturan.');
          console.error(e);
        }
      }
    }

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = (e) => reject(e);
        reader.readAsDataURL(file);
      });
    }

    // Excel Template Functions
    function downloadPrayerScheduleTemplate() {
      // Create worksheet data
      const ws_data = [
        ['Jadwal Sholat - Template Excel'],
        [],
        ['Hari/Tanggal', 'Imsak', 'Subuh', 'Dhuha', 'Dhuhur', 'Ashar', 'Maghrib', 'Isya'],
        ['Senin', '04:30', '04:40', '06:00', '12:00', '15:30', '17:45', '19:15'],
        ['Selasa', '04:25', '04:35', '05:55', '11:55', '15:25', '17:40', '19:10'],
        ['Rabu', '04:20', '04:30', '05:50', '11:50', '15:20', '17:35', '19:05'],
        ['Kamis', '04:15', '04:25', '05:45', '11:45', '15:15', '17:30', '19:00'],
        ['Jumat', '04:10', '04:20', '05:40', '11:40', '15:10', '17:25', '18:55'],
        ['Sabtu', '04:15', '04:25', '05:45', '11:45', '15:15', '17:30', '19:00'],
        ['Ahad', '04:20', '04:30', '05:50', '11:50', '15:20', '17:35', '19:05']
      ];
      
      // Create worksheet
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      
      // Set column widths
      const colWidths = [
        {wch: 15}, // Hari/Tanggal
        {wch: 8}, // Imsak
        {wch: 8}, // Subuh
        {wch: 8}, // Dhuha
        {wch: 8}, // Dhuhur
        {wch: 8}, // Ashar
        {wch: 8}, // Maghrib
        {wch: 8}  // Isya
      ];
      ws['!cols'] = colWidths;
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Jadwal Sholat');
      
      // Export file
      XLSX.writeFile(wb, 'jadwal_sholat_template.xlsx');
    }

    function handleExcelUpload(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          // Read the Excel file
          const data = new Uint8Array(e.target.result);
          const wb = XLSX.read(data, { type: 'array' });
          
          // Get first worksheet
          const ws = wb.Sheets[wb.SheetNames[0]];
          
          // Convert to JSON
          const jsonData = XLSX.utils.sheet_to_json(ws, { header: 1 });
          
          // Find the row with headers (look for 'Subuh' and 'Dhuhur')
          let headerRowIdx = -1;
          for (let i = 0; i < Math.min(jsonData.length, 10); i++) {
            const row = jsonData[i];
            if (row && Array.isArray(row)) {
              const rowStr = row.join('|').toLowerCase();
              if (rowStr.includes('subuh') && rowStr.includes('dhuhur')) {
                headerRowIdx = i;
                break;
              }
            }
          }
          
          if (headerRowIdx === -1) {
            alert('Format file tidak dikenali. Pastikan file memiliki kolom waktu sholat (Imsak, Subuh, Dhuhur, dsb).');
            return;
          }
          
          // Look for the first data row after header
          let foundData = false;
          for (let i = headerRowIdx + 1; i < jsonData.length; i++) {
            const row = jsonData[i];
            if (row && Array.isArray(row) && row.length >= 7) {
              // Find column indices by checking header row
              const headerRow = jsonData[headerRowIdx];
              
              // Map headers to column indices
              const colMap = {};
              for (let j = 0; j < headerRow.length; j++) {
                if (headerRow[j]) {
                  const header = String(headerRow[j]).toLowerCase().trim();
                  colMap[header] = j;
                }
              }
              
              // Update prayer times based on column mapping
              if (colMap['imsak'] !== undefined && row[colMap['imsak']]) {
                CONFIG.waktu_sholat.imsak = String(row[colMap['imsak']]);
              }
              if (colMap['subuh'] !== undefined && row[colMap['subuh']]) {
                CONFIG.waktu_sholat.subuh = String(row[colMap['subuh']]);
              }
              if (colMap['dhuha'] !== undefined && row[colMap['dhuha']]) {
                CONFIG.waktu_sholat.dhuha = String(row[colMap['dhuha']]);
              }
              if (colMap['dhuhur'] !== undefined && row[colMap['dhuhur']]) {
                CONFIG.waktu_sholat.dhuhur = String(row[colMap['dhuhur']]);
              }
              if (colMap['ashar'] !== undefined && row[colMap['ashar']]) {
                CONFIG.waktu_sholat.ashar = String(row[colMap['ashar']]);
              }
              if (colMap['maghrib'] !== undefined && row[colMap['maghrib']]) {
                CONFIG.waktu_sholat.maghrib = String(row[colMap['maghrib']]);
              }
              if (colMap['isya'] !== undefined && row[colMap['isya']]) {
                CONFIG.waktu_sholat.isya = String(row[colMap['isya']]);
              }
              
              foundData = true;
              break;
            }
          }
          
          if (!foundData) {
            alert('Tidak ditemukan data jadwal sholat dalam file.');
            return;
          }
          
          // Save the updated configuration
          localStorage.setItem('mosqueConfig', JSON.stringify(CONFIG));
          alert('Jadwal sholat berhasil diperbarui dari file Excel!');
          location.reload();
          
        } catch (error) {
          console.error('Error processing Excel file:', error);
          alert('Terjadi kesalahan saat memproses file Excel: ' + error.message);
        }
      };
      reader.onerror = function() {
        alert('Terjadi kesalahan saat membaca file Excel.');
      };
      reader.readAsArrayBuffer(file);
    }

    // Initialize app
    renderApp();
  </script>
 </body>
</html>
